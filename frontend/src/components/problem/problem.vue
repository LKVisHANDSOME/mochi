<template>
<div>
  <error v-if="error" :error="error" />
  <loading v-if="loading" loading="Testcase is running" />
  <info v-if="return_status" :info="'Testcase status: ' + return_status" />
  <h1>{{ info.name }}</h1>
  <div class="container-fluid">
    <div class="row">
      <div class="col-lg-2">
        <div class="row mb-3">
          <div class="col">
            <div class="mb-3">
              <label for="timeLimit" class="form-label">Time Limit</label>
              <input :value="info.time_limit + 's'" type="text" class="form-control" id="timeLimit" disabled readonly>
            </div>
            <div class="mb-3">
              <label for="memoryLimit" class="form-label">Memory Limit</label>
              <input :value="info.memory_limit + 'MB'" type="text" class="form-control" id="memoryLimit" disabled readonly>
            </div>
            <select v-model="info.language" class="form-select" aria-label="language">
              <option disabled>language</option>
              <option v-for="l in languages" :key="l">{{ l }}</option>
            </select>
          </div>
          <div class="col">
            <div class="mb-2">
              <label for="uploadCode" class="form-label">Upload Code</label>
              <input class="form-control" type="file" id="uploadCode" accept=".c,.cpp,.py" @change="uploadFile">
            </div>
            <span class="mb-2">Difficulty: {{ info.difficulty }}</span>
            <button type="button" @click="onClickDescBtn" class="btn my-2" :class="showDesc() ? 'btn-primary' : 'btn-outline-primary'">Desciption</button>
            <button type="button" @click="onClickSubBtn" class="btn my-2" :class="showSub() ? 'btn-secondary' : 'btn-outline-secondary'">Submission</button>
          </div>
        </div>
        <div class="mb-3">
          <button class="btn btn-success m-2">Sumit</button>
          <button class="btn btn-success m-2" @click="onTest()">Test</button>
        </div>
        <div class="mb-3">
          <label for="testInput" class="form-label">Test Input</label>
          <textarea v-model="test_case.input" class="form-control" id="testInput" rows="3" style="resize: none;"></textarea>
        </div>
        <div class="mb-3">
          <label for="testOutput" class="form-label">Test Output</label>
          <textarea v-model="test_case.output" class="form-control" id="testOutput" rows="3" style="resize: none;" disabled readonly></textarea>
        </div>
      </div>
      <div class="col-lg-4 text-start" v-show="showDesc()">
        {{ info.content }}
      </div>
      <div class="col-lg-4 text-start" v-show="showSub()">{{  }}</div>
      <div class="col-lg">
        <v-ace-editor
          v-model:value="code"
          @init="editorInit"
          :lang="aceLanguage"
          theme="monokai"
          style="height: 800px;"
          id="editor"
        />
      </div>
    </div>
  </div>
</div>
</template>

<script>
import { VAceEditor } from 'vue3-ace-editor'
import 'ace-builds/src-noconflict/mode-text'
import 'ace-builds/src-noconflict/mode-c_cpp'
import 'ace-builds/src-noconflict/mode-python'
import 'ace-builds/src-noconflict/theme-monokai.js'
// import 'ace-builds/src-noconflict/theme-chrome.js'
import axios from 'axios'
import Error from '../error.vue'
import Loading from '../loading.vue'
import Info from '../info.vue'

export default {
  name: 'Problem',
  data() {
    return {
      // when add new language to this array
      // you need to update the mode and the
      // language config(aceLanguage()) for ace editor
      languages: ["c", "c++", "python"],
      panel: "description",
      source_id: null,

      code: "",
      test_case: {input: "", output: ""},

      info: {
        id: "",
        name: "",
        language: "language",
        content: "",
        questioner_id: "",
        difficulty: "",
        time_limit: "",
        memory_limit: "",
      },

      error: null,
      loading: false,
      return_status: null
    }
  },
  computed: {
    aceLanguage() {
      if (this.info.language === "language") return "text"
      if (this.info.language === "c" || this.info.language === "c++") return "c_cpp"
      return this.info.language
    }
  },
  methods: {
    editorInit() {
      // do nothing
    },
    showDesc() {
      return this.panel === "description"
    },
    showSub() {
      return this.panel === "submission"
    },
    onClickDescBtn() {
      this.panel = "description"
    },
    onClickSubBtn() {
      this.panel = "submission"
    },
    uploadFile(evt) {
      const reader = new FileReader()
      reader.onload = (evt) => {
        this.code = evt.target.result
      }
      reader.readAsText(evt.target.files[0])
    },
    onTest() {
      this.error = null
      this.loading = false
      this.return_status = null

      if (this.$store.getters.userInfo === null) {
        this.$router.push("/login")
        return
      }

      if (this.info.language === "language") {
        this.error = "Please select a language."
        return
      }
      

      const payload = {
        user_id: this.$store.getters.userInfo.user_id,
        problem_id: this.info.id,
        language: this.info.language,
        code_content: this.code,
        test_case: this.test_case.input
      }

      axios.post('/problem/test_run', payload)
      .then( res => {
        this.source_id = res.data.source_id
      })
      .catch( error => this.error = error)

      this.loading = true

      const get_test_interval = setInterval( () => {
        axios.get('/problem/test_run', {
          params: {
            source_id: this.source_id,
            user_id: this.$store.getters.userInfo.user_id
          }
        })
        .then( res => {
          const message = res.data.message
          if (message === "pending") {
            return
          }

          clearInterval(get_test_interval)
          this.loading = false

          this.return_status = res.data.status
          this.test_case.output = res.data.output
          if (message !== "OK") this.error = message
        })
        .catch( error => {
          clearInterval(get_test_interval)
          this.error = error
        })
      }, 1000)

      
    }
  },
  components: {
    VAceEditor,
    Error,
    Loading,
    Info
  },
  created() {
    this.info.id = this.$route.params.problemId
    axios.get('/problem/' + this.info.id)
    .then( res => {
      if (res.data.code === 404) {
        this.error = res.data.message
      } else {
        this.info.id = res.data.problem_id
        this.info.name = res.data.name
        this.info.questioner_id = res.data.questioner_id
        this.info.difficulty = res.data.difficulty
        this.info.content = res.data.content
        this.info.time_limit = res.data.time_limit
        this.info.memory_limit = res.data.memory_limit
        this.info.sample_input = res.data.sample_input
        this.info.sample_output = res.data.sample_output
      }
    })
    .catch( e => { this.error = e})
  }
}
</script>

<style>
#editor *{
  font-family : monospace !important;font-size: 20px !important;direction:ltr !important;text-align:left !important;
}
</style>
